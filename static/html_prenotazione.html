<!DOCTYPE html>
<html>

<head>
    <title>MyTeacher - Prenotazione</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet"
        href="https://mdbcdn.b-cdn.net/wp-content/themes/mdbootstrap4/docs-app/css/dist/mdb5/standard/core.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css"
        integrity="sha256-3sPp8BkKUE7QyPSl6VfBByBroQbKxKG7tsusY2mhbVY=" crossorigin="anonymous" />
    <style>
        .myTeacherlogo {

            font-family: 'Tahoma';
            font-style: normal;
            font-weight: 900;
            font-size: 3rem;
            line-height: 63px;
            /* identical to box height */
            text-align: center;

            color: #F40000;

            -webkit-text-stroke: 1px black;

        }

        .hide_div {
            opacity: 0;
        }

        .show_div {
            opacity: 100;
        }

        body {
            background: #f5f5f5;
            margin-top: 20px;
        }

        /* ===== Career ===== */
        .career-form {
            background-color: #4e63d7;
            border-radius: 5px;
            padding: 0 16px;
        }

        .career-form .form-control {
            background-color: rgba(255, 255, 255, 0.2);
            border: 0;
            padding: 12px 15px;
            color: #fff;
        }

        .career-form .form-control::-webkit-input-placeholder {
            /* Chrome/Opera/Safari */
            color: #fff;
        }

        .career-form .form-control::-moz-placeholder {
            /* Firefox 19+ */
            color: #fff;
        }

        .career-form .form-control:-ms-input-placeholder {
            /* IE 10+ */
            color: #fff;
        }

        .career-form .form-control:-moz-placeholder {
            /* Firefox 18- */
            color: #fff;
        }

        .career-form .custom-select {
            background-color: rgba(255, 255, 255, 0.2);
            border: 0;
            padding: 12px 15px;
            color: #fff;
            width: 100%;
            border-radius: 5px;
            text-align: left;
            height: auto;
            background-image: none;
        }

        .career-form .custom-select:focus {
            -webkit-box-shadow: none;
            box-shadow: none;
        }

        .career-form .select-container {
            position: relative;
        }

        .career-form .select-container:before {
            position: absolute;
            right: 15px;
            top: calc(50% - 14px);
            font-size: 18px;
            color: #ffffff;
            content: '\F2F9';
            font-family: "Material-Design-Iconic-Font";
        }

        .filter-result .job-box {
            -webkit-box-shadow: 0 0 35px 0 rgba(130, 130, 130, 0.2);
            box-shadow: 0 0 35px 0 rgba(130, 130, 130, 0.2);
            border-radius: 10px;
            padding: 10px 35px;
        }

        ul {
            list-style: none;
        }

        .list-disk li {
            list-style: none;
            margin-bottom: 12px;
        }

        .list-disk li:last-child {
            margin-bottom: 0;
        }

        .job-box .img-holder {
            height: 65px;
            width: 65px;
            background-color: #4e63d7;
            background-image: -webkit-gradient(linear, left top, right top, from(rgba(78, 99, 215, 0.9)), to(#5a85dd));
            background-image: linear-gradient(to right, rgba(78, 99, 215, 0.9) 0%, #5a85dd 100%);
            font-family: "Open Sans", sans-serif;
            color: #fff;
            font-size: 22px;
            font-weight: 700;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            border-radius: 65px;
        }

        .career-title {
            background-color: #4e63d7;
            color: #fff;
            padding: 15px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            background-image: -webkit-gradient(linear, left top, right top, from(rgba(78, 99, 215, 0.9)), to(#5a85dd));
            background-image: linear-gradient(to right, rgba(78, 99, 215, 0.9) 0%, #5a85dd 100%);
        }

        .job-overview {
            -webkit-box-shadow: 0 0 35px 0 rgba(130, 130, 130, 0.2);
            box-shadow: 0 0 35px 0 rgba(130, 130, 130, 0.2);
            border-radius: 10px;
        }

        @media (min-width: 992px) {
            .job-overview {
                position: -webkit-sticky;
                position: sticky;
                top: 70px;
            }
        }

        .job-overview .job-detail ul {
            margin-bottom: 28px;
        }

        .job-overview .job-detail ul li {
            opacity: 0.75;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .job-overview .job-detail ul li i {
            font-size: 20px;
            position: relative;
            top: 1px;
        }

        .job-overview .overview-bottom,
        .job-overview .overview-top {
            padding: 35px;
        }

        .job-content ul li {
            font-weight: 600;
            opacity: 0.75;
            border-bottom: 1px solid #ccc;
            padding: 10px 5px;
        }

        @media (min-width: 768px) {
            .job-content ul li {
                border-bottom: 0;
                padding: 0;
            }
        }

        .job-content ul li i {
            font-size: 20px;
            position: relative;
            top: 1px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .image_print {
            max-height: 3.5rem;
            max-width: 3.5rem;
            min-height: 3.5rem;
            min-width: 3.5rem;
        }
    </style>

</head>
<div class="container mt-1">
    <nav class="navbar navbar-light bg-light px-3">
        <div id="professor_tab">
            <img id="pAccountPhoto" class="image_print" src="" alt="">
            <text id="pname"></text>
            <text id="psurname"></text><br>
            <text id="psubjects"></text><br>
            <text id="ptopics"></text><br>
            <text id="pprice"></text>



        </div>
    </nav>
    <br>

    <div id="hidden_div" class="hide_div">
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                <path
                    d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
            </svg>
            <text style="color: hsla(0, 0%, 100%, 0)">12</text>
            <text id="alert_msg"></text>
        </div>
    </div>


    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="career-search mb-60">


                <div id="result" class="filter-result">


                </div>
            </div>

        </div>
    </div>

    <!-- Book lesson -->
    <div class="modal fade" id="book" tabindex="-1" role="dialog" aria-labelledby="book" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div id="modal_head" class="modal-head">

                    <div id="error_modal" class="hide_div">
                        <div class="d-flex justify-content-center">
                        <div class="alert alert-danger d-flex align-items-center d-inline-flex bd-highlight m-2" role="alert">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                                <path
                                    d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                            </svg>
                            <text style="color: hsla(0, 0%, 100%, 0)">12</text>
                            <text>Seleziona almeno una materia e almeno un argomento.</text>
                        </div>
                    </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <b><div class="alert alert-success d-inline-flex p-2 bd-highlight">
                            <text id="resume_lesson" class="d-flex align-items-end"></text>
                        </div></b>
                    </div>
                </div>
                <hr>
                <div class="modal-body">
                    <div class="card card-body">
                        <div class="d-flex justify-content-center">
                            <div id="choose_form" class="row g-3">
                                <div class="col-md-6">
                                    <div id="subject-form">
                                        <text>Per quale/i materie?</text>
                                        <div id="subject-form-check" class="form-check">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div id="topics-form">
                                        <text>Per quale/i materie?</text>
                                        <div id="topics-form-check" class="form-check">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center modal-footer">
                    <button id="btn_book" type="button" class="btn btn-danger" onclick="checkSubmission()">Prenota</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success -->
    <div class="modal fade" id="success" tabindex="-1" role="dialog" aria-labelledby="success" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    Lezione prenotata!
                </div>
                <div class="d-flex justify-content-center modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                        onclick="window.location = 'ricerca.html'">Vai alla
                        home</button>
                </div>
            </div>
        </div>
    </div>
</div>

<body>




</body>
<script>

    numTopics = 0;
    numSubjects = 0;

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const professorUsername = urlParams.get('professor')
    getUserInfo(professorUsername);

    /**
     * Request a user data
    **/
    function getUserInfo(username) {
        name = "";
        surname = "";
        image = "data:image/jpeg;base64,";
        price = "";


        const xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function () {
            const json = this.responseText;
            var jsonData = JSON.stringify(json);
            const jsondoc = JSON.parse(json);
            name = jsondoc.nome;
            surname = jsondoc.cognome;
            image = image + jsondoc.image;
            price = "" + jsondoc.prezzo + " €/h";
            topics = "Argomenti:  " + jsondoc.argomenti;
            subjects = "Materie:  " + jsondoc.materie;



            fillModal(jsondoc.materie, jsondoc.argomenti);
            printProfessor(name, surname, image, price, subjects, topics);
            getLesson(username)

        }


        xhttp1.open("GET", "/api/v1/users/" + username, false);
        xhttp1.send();
    }

    function fillModal(subjects, topics) {

        numTopics = topics.length;
        numSubjects = subjects.length;

        for (let i = 0; i < subjects.length; i++) {
            let input = document.createElement("input");
            input.setAttribute("class", "form-check-input");
            input.setAttribute("type", "checkbox");
            input.setAttribute("value", subjects[i]);
            input.setAttribute("id", "s" + i);
            let label = document.createElement("label");
            label.setAttribute("class", "form-check-label");
            label.setAttribute("for", "s" + i);
            label.innerHTML = subjects[i];

            document.getElementById("subject-form-check").appendChild(input);
            document.getElementById("subject-form-check").appendChild(label);

        }

        for (let i = 0; i < topics.length; i++) {
            let input = document.createElement("input");
            input.setAttribute("class", "form-check-input");
            input.setAttribute("type", "checkbox");
            input.setAttribute("value", topics[i]);
            input.setAttribute("id", "t" + i);
            let label = document.createElement("label");
            label.setAttribute("class", "form-check-label");
            label.setAttribute("for", "t" + i);
            label.innerHTML = topics[i];

            document.getElementById("topics-form-check").appendChild(input);
            document.getElementById("topics-form-check").appendChild(label);


        }
    }

    /**
     * Get lessons
    **/
    function getLesson(username) {

        const xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function () {

            const json = this.responseText;


            printLessons(json)

        }


        xhttp2.open("GET", "/api/v2/notBookedLection/" + username, false);
        xhttp2.send();
    }


    /**
     * Print professor info
    **/
    function printProfessor(name, surname, image, price, subjects, topics) {
        document.getElementById("pAccountPhoto").setAttribute("src", image);
        document.getElementById("pname").innerHTML = name;
        document.getElementById("psurname").innerHTML = surname;
        document.getElementById("pprice").innerHTML = price;
        document.getElementById("psubjects").innerHTML = subjects;
        document.getElementById("ptopics").innerHTML = topics;

    }

    /**
     * Print page with all lesson for that user
    **/
    function printLessons(lessons) {
        const aJSON = JSON.parse(lessons);

        for (let i = 0; i < aJSON.length; i++) {

            tmp = aJSON[i];


            topics = "" + tmp.argomenti;
            subjects = "" + tmp.materie;

            div1 = document.createElement("div");
            div1.setAttribute("class", "job-box d-md-flex align-items-center justify-content-between mb-30");
            div2 = document.createElement("div");
            div2.setAttribute("class", "job-left my-4 d-md-flex align-items-center flex-wrap");
            div3 = document.createElement("div");
            div3.setAttribute("class", "job-content");
            ul = document.createElement("ul");
            ul.setAttribute("class", "d-md-flex flex-wrap text-capitalize ff-open-sans");
            li1 = document.createElement("li")
            li1.setAttribute("class", "mr-md-4");
            date = document.createElement("i");
            date.setAttribute("class", "");
            date.setAttribute("id", "d" + tmp._id);
            date.innerHTML = " " + (tmp.date).slice(0, 10) + " ";
            li2 = document.createElement("li")
            li2.setAttribute("class", "mr-md-4");
            time = document.createElement("i");
            time.setAttribute("class", "");
            time.setAttribute("id", "t" + tmp._id);
            time.innerHTML = "   " + tmp.start_time + " - " + tmp.end_time;
            div4 = document.createElement("div");
            div4.setAttribute("class", "job-right my-4 flex-shrink-0");
            btn = document.createElement("a");
            btn.setAttribute("class", "btn btn-danger");
            btn.setAttribute("onclick", "selecLesson(this.id)");
            btn.innerHTML = "Prenota";
            btn.setAttribute("id", "b" + tmp._id);

            liText = document.createElement("text");
            liText.setAttribute("style", "opacity: 0");
            liText.innerHTML = "12";

            li1.appendChild(date);
            li2.appendChild(time);
            ul.appendChild(li1);
            ul.appendChild(liText);
            ul.appendChild(li2);
            div3.appendChild(ul);
            div2.appendChild(div3);
            div1.appendChild(div2);
            div4.appendChild(btn);
            div1.appendChild(div4);
            document.getElementById("result").appendChild(div1);
        }

    }

    idSelected = "";

    function selecLesson(btId) {
        document.getElementById("error_modal").setAttribute("class", "hide_div");
        document.getElementById("hidden_div").setAttribute("class", "hide_div");

        idLesson = btId.slice(1);
        idDate = "d" + idLesson;
        idTime = "t" + idLesson;

        idSelected = idLesson;
        timeSelected = document.getElementById(idTime).innerHTML;
        dateSelected = document.getElementById(idDate).innerHTML;
        document.getElementById("resume_lesson").innerHTML = dateSelected + "  " + timeSelected;


        $("#book").modal('toggle');
    }

    function checkSubmission() {

        let nCheckS = 0;
        let nCheckT = 0;
        for (let i = 0; i < numSubjects; i++) {
            if (document.getElementById("s" + i).checked) {
                nCheckS++;
            }
        }

        for (let i = 0; i < numTopics; i++) {
            if (document.getElementById("t" + i).checked) {
                nCheckT++;
            }
        }  

        btn = document.getElementById("btn_book");

        if (nCheckS > 0 && nCheckT > 0) {
            
            btn.setAttribute("onclick","");
            btn.setAttribute("data-bs-dismiss","modal");
            btn.click();
            btn.removeAttribute("data-bs-dismiss");
            btn.setAttribute("onclick","checkSubmission()");
            createJSON();
        } else {
            btn.removeAttribute("data-bs-dismiss");
            document.getElementById("error_modal").setAttribute("class", "show_div")

        }
    }

    function createJSON() {
        aSubjects = "";
        aTopics = "";

        for (let i = 0; i < numSubjects; i++) {
            if (document.getElementById("s" + i).checked) {
                aSubjects = aSubjects + '"' + document.getElementById("s" + i).value + '",';
            }
        }
        aSubjects = aSubjects.slice(0, -1);

        for (let i = 0; i < aTopics; i++) {
            if (document.getElementById("t" + i).checked) {
                aTopics = aTopics + '"' + document.getElementById("t" + i).value + '",';
            }
        }
        aTopics = aTopics.slice(0, -1);




        jsonToSend = '{"materie": [' + aSubjects + '], "argomenti": [' + aTopics + '], "lection_id": "' + idSelected + '"}';

        bookLesson(jsonToSend)
    }

    /* function bookLesson(jsonToSend) {
         const xhttp3 = new XMLHttpRequest();
         xhttp3.onreadystatechange = function () {
 
             const json = this.responseText;
             const jsondoc = JSON.parse(json);
 
 
             msg = jsondoc.message;
             if (this.readyState == 4 && this.status == 200) {
                 $("#success").modal('toggle');
 
             } else if (this.readyState == 4 && this.status == 400) {
                 document.getElementById("hidden_div").setAttribute("class", "show_div");
                 document.getElementById("alert_msg").innerHTML = msg;
 
             } else if (this.readyState == 4 && this.status == 500) {
                 document.getElementById("hidden_div").setAttribute("class", "show_div");
                 document.getElementById("alert_msg").innerHTML = msg;
 
             }
 
         }
 
         xhttp3.open("POST", "/api/v1/prenota", false);
         xhttp3.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
         xhttp3.send(jsonToSend);
 
     }*/

    function bookLesson(jsonToSend) {

        
        fetch('../api/v1/prenota', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: jsonToSend,
        })

            .then(r => r.json().then(data => ({ status: r.status, body: data })))
            .then(obj => {
                msg = obj.body.message;
                if (obj.status == 200) {
                    $("#success").modal('toggle');

                } else if (obj.status == 400) {
                    document.getElementById("hidden_div").setAttribute("class", "show_div");
                    document.getElementById("alert_msg").innerHTML = msg;

                } else if (obj.status == 500) {
                    document.getElementById("hidden_div").setAttribute("class", "show_div");
                    document.getElementById("alert_msg").innerHTML = msg;

                }
            })
            .catch(error => console.error(error));
    }

</script>