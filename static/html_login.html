<!DOCTYPE html>
<html>

<head>
    <title>Login</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet"
        href="https://mdbcdn.b-cdn.net/wp-content/themes/mdbootstrap4/docs-app/css/dist/mdb5/standard/core.min.css">
</head>

<style>

    .myTeacherlogo {

        font-family: 'Tahoma';
        font-style: normal;
        font-weight: 900;
        font-size: 3rem;
        line-height: 63px;
        /* identical to box height */
        text-align: center;

        color: #F40000;

        -webkit-text-stroke: 1px black;

    }

    .hide_div {
        opacity: 0;
    }

    .show_div {
        opacity: 100;
    }
</style>
</head>

<body>
    <div class="container mt-5">

        <section class="py-3">
            <text id="logo" class="myTeacherlogo d-flex justify-content-center align-items-center mb-5">MyTeacher</text>

            <div class="row d-flex justify-content-center">
                <div class="col-12 col-md-8 col-lg-6 col-xl-6">
                    <div class="card shadow-2-strong" style="border-radius: 1rem;">
                        <div class="card-body p-5 text-center">


                            <h1 style="color: #f93154" class="py-2">Accedi</h1>
                            <div id="hidden_div" class="hide_div">
                                <div class="alert alert-danger d-flex align-items-center" role="alert">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                                        <path
                                            d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                                    </svg>
                                    <text style="color: hsla(0, 0%, 100%, 0)">12</text>
                                    <text id="alert_msg"></text>
                                </div>
                                <br>
                            </div>


                            <div class="form-outline mb-4">
                                <input type="email" id="email" class="form-control form-control-lg active" required>
                                <label class="form-label" for="email" style="margin-left: 0px;">Email</label>
                                <div class="invalid-feedback">
                                    Indirizzo email non valido.
                                </div>
                                <div class="valid-feedback">
                                    Va bene!
                                </div>
                                <div class="form-notch">
                                    <div class="form-notch-leading" style="width: 9px;"></div>
                                    <div class="form-notch-middle" style="width: 40px;"></div>
                                    <div class="form-notch-trailing"></div>
                                </div>
                            </div>
                            <br>

                            <div class="form-outline mb-4">
                                <input type="password" id="pwd" class="form-control form-control-lg active" required>
                                <label class="form-label" for="pwd" style="margin-left: 0px;">Password</label>
                                <div class="invalid-feedback">
                                    Password non valida.
                                </div>
                                <div class="valid-feedback">
                                    Va bene!
                                </div>
                                <div class="form-notch">
                                    <div class="form-notch-leading" style="width: 9px;"></div>
                                    <div class="form-notch-middle" style="width: 64.8px;"></div>
                                    <div class="form-notch-trailing"></div>
                                </div>
                            </div>
                            <br>

                            <button class="btn btn-danger btn-lg btn-block" onclick="resetFieldError()">Login</button>


                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- Modal1 -->
    <div class="modal fade" id="Modal1" tabindex="-1" role="dialog" aria-labelledby="Modal1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div id="msg_modal" class="modal-body d-flex justify-content-center"></div>
                <div class="d-flex justify-content-center modal-footer">
                    <button type="button" class="btn btn-primary" onclick="window.location = 'ricerca.html'">Vai alla
                        home</button>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    /**
     * Remove the error message from all the field before the new request
     * Then call the encodeImageFileURL function
    **/
    function resetFieldError() {
        var fields = document.getElementsByClassName("form-control form-control-lg active is-invalid");
        for (var i = 0; i < fields.length; i++) {
            fields.item(i).className = "form-control form-control-lg active";
        }
        document.getElementById("hidden_div").setAttribute("class", "hide_div");
        createJSONlogin()
    }

    /**
     * Create JSON to attemp the login
    **/
    function createJSONlogin() {
        email = "" + document.getElementById("email").value
        pwd = "" + document.getElementById("pwd").value

        jsonLogin = '{"email": "' + email + '", "password": "' + pwd + '"}'
        loginAttemp(jsonLogin)
    }


    /**
     * Send the login request data to the DB
     * Wait the confirmation or error response from the DB
    **/
    function loginAttemp(json) {
        console.log(json)
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            const json = this.responseText;
            var jsonData = JSON.stringify(json);
            const jsondoc = JSON.parse(json);
            //ALL OK, new user registered
            if (this.readyState == 4 && this.status == 200) {

                //link to new user
                msg = jsondoc.message;
                userToken = jsondoc.token;
                userSelf = jsondoc.self;

                document.getElementById("msg_modal").innerHTML = msg;

                $("#Modal1").modal('toggle');




            } else if (this.readyState == 4 && this.status == 400) {

                //invalid request
                msg = jsondoc.message
                document.getElementById("hidden_div").setAttribute("class", "show_div");
                document.getElementById("alert_msg").innerHTML = msg



                if (msg == "Errore, utente non trovato.") {

                    document.getElementById("email").classList.add("is-invalid")

                } else if (msg == "Errore, password errata.") {

                    document.getElementById("pwd").classList.add("is-invalid")

                }

            } else if (this.readyState == 4 && this.status == 500) {

                //internal server error
                msg = jsondoc.message
                document.getElementById("hidden_div").setAttribute("class", "hide_div");
                document.getElementById("alert_msg").innerHTML = msg


            }
        }


        xhttp.open("POST", "/api/v1/users/auth", true);
        xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhttp.send(json);
    }


</script>



</html>